const { useState, useEffect } = React;
const e = React.createElement;

const CATEGORY_COLORS = {
  symptom: {bg:'bg-emerald-500',selected:'bg-emerald-600',found:'bg-emerald-400',border:'border-emerald-400'},
  treatment: {bg:'bg-blue-500',selected:'bg-blue-600',found:'bg-blue-400',border:'border-blue-400'},
  lab: {bg:'bg-purple-500',selected:'bg-purple-600',found:'bg-purple-400',border:'border-purple-400'},
  risk: {bg:'bg-rose-500',selected:'bg-rose-600',found:'bg-rose-400',border:'border-rose-400'}
};

function getTodayDateString() {
  return new Date().toISOString().split('T')[0];
}

function seededRandom(seed) {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

function getPuzzleForDate(dateString) {
  const seed = dateString.split('-').reduce((acc,val) => acc+parseInt(val),0);
  const random = (index) => seededRandom(seed+index);
  const easy = ALL_DIAGNOSES.filter(d=>d.difficulty==='easy');
  const medium = ALL_DIAGNOSES.filter(d=>d.difficulty==='medium');
  const hard = ALL_DIAGNOSES.filter(d=>d.difficulty==='hard');
  return [
    easy[Math.floor(random(1)*easy.length)],
    medium[Math.floor(random(2)*medium.length)],
    medium[Math.floor(random(3)*medium.length)],
    hard[Math.floor(random(4)*hard.length)]
  ];
}

function shuffleArray(array,seed) {
  const shuffled=[...array];
  for(let i=shuffled.length-1;i>0;i--){
    const j=Math.floor(seededRandom(seed+i)*(i+1));
    [shuffled[i],shuffled[j]]=[shuffled[j],shuffled[i]];
  }
  return shuffled;
}

function DiagnoLink() {
  const [view,setView]=useState('menu');
  const [selectedDate,setSelectedDate]=useState(getTodayDateString());
  const [gameBoard,setGameBoard]=useState([]);
  const [selected,setSelected]=useState([]);
  const [foundGroups,setFoundGroups]=useState([]);
  const [attempts,setAttempts]=useState(0);
  const [gameOver,setGameOver]=useState(false);
  const [message,setMessage]=useState("");
  const [showResults,setShowResults]=useState(false);
  const [completedPuzzles,setCompletedPuzzles]=useState({});

  useEffect(()=>{
    const saved=localStorage.getItem('diagnoLinkCompleted');
    if(saved) setCompletedPuzzles(JSON.parse(saved));
  },[]);

  const saveCompletedPuzzle=(date,score)=>{
    const updated={...completedPuzzles,[date]:score};
    setCompletedPuzzles(updated);
    localStorage.setItem('diagnoLinkCompleted',JSON.stringify(updated));
  };

  const startGame=(dateString)=>{
    setSelectedDate(dateString);
    const selectedDiagnoses=getPuzzleForDate(dateString);
    const seed=dateString.split('-').reduce((acc,val)=>acc+parseInt(val),0);
    const allClues=selectedDiagnoses.flatMap((diagnosis,diagIndex)=>
      diagnosis.clues.map(clue=>({...clue,diagnosisIndex:diagIndex,diagnosisName:diagnosis.name}))
    );
    setGameBoard(shuffleArray(allClues,seed+100));
    setSelected([]);setFoundGroups([]);setAttempts(0);setGameOver(false);setMessage("");setShowResults(false);setView('daily');
  };

  const handleClueClick=(index)=>{
    if(gameOver||foundGroups.some(group=>group.includes(index))) return;
    if(selected.includes(index)) setSelected(selected.filter(i=>i!==index));
    else if(selected.length<4) setSelected([...selected,index]);
  };

  const handleSubmit=()=>{
    if(selected.length!==4){setMessage("Please select exactly 4 clues");setTimeout(()=>setMessage(""),2000);return;}
    const selectedClues=selected.map(i=>gameBoard[i]);
    const diagnosisIndex=selectedClues[0].diagnosisIndex;
    const isCorrect=selectedClues.every(clue=>clue.diagnosisIndex===diagnosisIndex);
    if(isCorrect){
      setFoundGroups([...foundGroups,selected]);setSelected([]);setMessage(`Correct! ${selectedClues[0].diagnosisName}`);
      setTimeout(()=>setMessage(""),2000);
      if(foundGroups.length===3){setGameOver(true);saveCompletedPuzzle(selectedDate,4);setTimeout(()=>setShowResults(true),1500);}
    }else{
      setAttempts(attempts+1);setMessage("Incorrect grouping. Try again!");setTimeout(()=>setMessage(""),2000);
      if(attempts+1>=4){setGameOver(true);saveCompletedPuzzle(selectedDate,foundGroups.length);setTimeout(()=>setShowResults(true),1500);}
    }
  };

  const getClueStyle=(index)=>{
    const clue=gameBoard[index];
    const isFound=foundGroups.some(group=>group.includes(index));
    const isSelected=selected.includes(index);
    const colors=CATEGORY_COLORS[clue.category];
    if(isFound) return `${colors.found} text-white cursor-not-allowed opacity-60`;
    if(isSelected) return `${colors.selected} text-white border-4 ${colors.border}`;
    return `${colors.bg} text-white hover:opacity-90 cursor-pointer`;
  };

  const generateArchiveDates=()=>{
    const dates=[];const today=new Date();
    for(let i=0;i<100;i++){
      const date=new Date(today);
      date.setDate(date.getDate()-i);
      dates.push(date.toISOString().split('T')[0]);
    }
    return dates;
  };

  if(view==='tutorial') return e('div',{className:'min-h-screen bg-slate-50 p-6 flex items-center justify-center'},
    e('div',{className:'max-w-md w-full bg-white rounded-lg shadow-lg border border-slate-200 p-8'},
      e('h2',{className:'text-3xl font-serif font-bold text-slate-800 text-center mb-6'},'How to Play'),
      e('div',{className:'space-y-4 text-slate-700'},
        e('p',{className:'leading-relaxed'},'Your goal is to identify 4 different diagnoses by grouping related medical clues.'),
        e('p',{className:'leading-relaxed'},'Each diagnosis is represented by exactly 4 clues: a ',
          e('span',{className:'font-semibold text-emerald-600'},'symptom'),', ',
          e('span',{className:'font-semibold text-blue-600'},'treatment'),', ',
          e('span',{className:'font-semibold text-purple-600'},'lab test'),', and ',
          e('span',{className:'font-semibold text-rose-600'},'risk factor'),'.'
        ),
        e('p',{className:'leading-relaxed'},'Select 4 clues you believe belong to the same condition, then tap Submit to check your answer.'),
        e('p',{className:'leading-relaxed'},'You have 4 attempts to find all groups.')
      ),
      e('button',{onClick:()=>setView('menu'),className:'w-full mt-8 bg-slate-800 hover:bg-slate-900 text-white font-semibold py-3 rounded-lg transition-colors'},'Got it')
    )
  );

  if(view==='menu'){
    const todayDate=getTodayDateString();
    const todayCompleted=completedPuzzles[todayDate];
    return e('div',{className:'min-h-screen bg-slate-50 p-6 flex items-center justify-center'},
      e('div',{className:'max-w-md w-full'},
        e('div',{className:'text-center mb-8'},
          e('h1',{className:'text-5xl font-serif font-bold text-slate-800 mb-2'},'DiagnoLink'),
          e('p',{className:'text-slate-500 text-sm tracking-wide'},'DAILY BOARD EXAM PREP')
        ),
        e('div',{className:'space-y-3'},
          e('button',{onClick:()=>startGame(todayDate),className:'w-full bg-slate-800 hover:bg-slate-900 text-white font-semibold py-5 px-6 rounded-lg transition-colors shadow-sm relative'},
            e('div',{className:'text-xl mb-1'},"Today's Puzzle"),
            e('div',{className:'text-sm opacity-90'},new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})),
            todayCompleted!==undefined&&e('div',{className:'absolute top-3 right-3 bg-emerald-500 text-white text-xs px-2 py-1 rounded'},`${todayCompleted}/4 ✓`)
          ),
          e('button',{onClick:()=>setView('tutorial'),className:'w-full bg-white hover:bg-slate-50 text-slate-700 font-semibold py-4 px-6 rounded-lg border border-slate-300 transition-colors'},e('div',{className:'text-lg'},'How to Play')),
          e('button',{onClick:()=>setView('archive'),className:'w-full bg-white hover:bg-slate-50 text-slate-700 font-semibold py-4 px-6 rounded-lg border border-slate-300 transition-colors'},e('div',{className:'text-lg'},'Archive'),e('div',{className:'text-sm opacity-75'},'100 past puzzles'))
        ),
        e('div',{className:'mt-6 text-center text-slate-500 text-xs'},`${Object.keys(completedPuzzles).length} puzzles completed • ${ALL_DIAGNOSES.length} diagnoses`)
      )
    );
  }

  if(view==='archive'){
    const archiveDates=generateArchiveDates();
    return e('div',{className:'min-h-screen bg-slate-50 p-6'},
      e('div',{className:'max-w-2xl mx-auto'},
        e('div',{className:'flex items-center justify-between mb-6'},
          e('button',{onClick:()=>setView('menu'),className:'text-slate-600 hover:text-slate-800 font-medium'},'← Back'),
          e('h1',{className:'text-2xl font-serif font-bold text-slate-800'},'Archive'),
          e('div',{className:'w-16'})
        ),
        e('div',{className:'grid grid-cols-1 gap-2'},
          ...archiveDates.map(date=>{
            const dateObj=new Date(date+'T00:00:00');
            const isToday=date===getTodayDateString();
            const completed=completedPuzzles[date];
            return e('button',{key:date,onClick:()=>startGame(date),className:'bg-white hover:bg-slate-50 border border-slate-200 rounded-lg p-4 text-left transition-colors flex items-center justify-between'},
              e('div',null,
                e('div',{className:'font-semibold text-slate-800'},dateObj.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})),
                isToday&&e('div',{className:'text-xs text-blue-600 font-medium'},'Today')
              ),
              completed!==undefined&&e('div',{className:`px-3 py-1 rounded text-sm font-medium ${completed===4?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-600'}`},`${completed}/4`)
            );
          })
        )
      )
    );
  }

  if(showResults){
    const allDiagnoses=[...new Set(gameBoard.map(clue=>clue.diagnosisName))];
    return e('div',{className:'min-h-screen bg-slate-50 p-6'},
      e('div',{className:'max-w-2xl mx-auto'},
        e('div',{className:'text-center mb-6'},
          e('h1',{className:'text-3xl font-serif font-bold text-slate-800 mb-2'},foundGroups.length===4?'Perfect Score!':'Game Over'),
          e('p',{className:'text-slate-600'},`You found ${foundGroups.length} out of 4 groups`)
        ),
        e('div',{className:'space-y-3 mb-6'},
          ...allDiagnoses.map((diagnosisName,idx)=>{
            const diagnosisClues=gameBoard.filter(clue=>clue.diagnosisName===diagnosisName);
            const wasFound=foundGroups.some(group=>diagnosisClues.every(clue=>group.includes(gameBoard.indexOf(clue))));
            return e('div',{key:idx,className:`rounded-lg p-4 border-2 ${wasFound?'bg-emerald-50 border-emerald-300':'bg-slate-100 border-slate-300'}`},
              e('h3',{className:'font-semibold text-slate-800 mb-3 flex items-center gap-2'},
                e('span',{className:wasFound?'text-emerald-600':'text-slate-400'},wasFound?'✓':'✗'),
                diagnosisName
              ),
              e('div',{className:'grid grid-cols-2 gap-2'},
                ...diagnosisClues.map((clue,clueIdx)=>{
                  const colors=CATEGORY_COLORS[clue.category];
                  return e('div',{key:clueIdx,className:`${colors.bg} text-white text-xs p-2 rounded leading-tight`},clue.text);
                })
              )
            );
          })
        ),
        e('div',{className:'space-y-3'},
          e('button',{onClick:()=>setView('menu'),className:'w-full bg-slate-800 hover:bg-slate-900 text-white font-semibold py-3 rounded-lg transition-colors'},'Back to Menu'),
          e('button',{onClick:()=>setView('archive'),className:'w-full bg-white hover:bg-slate-50 text-slate-700 font-semibold py-3 rounded-lg border border-slate-300 transition-colors'},'View Archive')
        )
      )
    );
  }

  return e('div',{className:'min-h-screen bg-slate-50 p-4 pb-8'},
    e('div',{className:'max-w-2xl mx-auto'},
      e('div',{className:'flex items-center justify-between mb-4 pt-2'},
        e('button',{onClick:()=>setView('menu'),className:'text-slate-600 hover:text-slate-800 font-medium'},'← Menu'),
        e('div',{className:'text-center'},e('h1',{className:'text-2xl font-serif font-bold text-slate-800'},'DiagnoLink')),
        e('button',{onClick:()=>setView('tutorial'),className:'text-slate-600 hover:text-slate-800'},'?')
      ),
      e('div',{className:'bg-white border border-slate-200 rounded-lg p-3 mb-4 text-center shadow-sm'},
        e('p',{className:'text-slate-600 text-sm leading-snug'},'Find groups of 4 clues belonging to the same diagnosis')
      ),
      e('div',{className:'flex justify-between mb-4 gap-3'},
        e('div',{className:'flex-1 bg-white border border-slate-200 rounded-lg px-4 py-2 text-center'},
          e('span',{className:'text-slate-600 text-sm'},'Groups: ',e('strong',{className:'text-slate-800'},`${foundGroups.length}/4`))
        ),
        e('div',{className:'flex-1 bg-white border border-slate-200 rounded-lg px-4 py-2 text-center'},
          e('span',{className:'text-slate-600 text-sm'},'Attempts: ',e('strong',{className:'text-slate-800'},`${4-attempts}`))
        )
      ),
      message&&e('div',{className:`text-center mb-4 p-3 rounded-lg font-medium ${message.includes('Correct')?'bg-emerald-100 text-emerald-800 border border-emerald-300':'bg-rose-100 text-rose-800 border border-rose-300'}`},message),
      e('div',{className:'grid grid-cols-4 gap-2 mb-6'},
        ...gameBoard.map((clue,index)=>
          e('button',{key:index,onClick:()=>handleClueClick(index),className:`${getClueStyle(index)} p-2 rounded-lg text-xs font-medium transition-all duration-200 min-h-[85px] flex items-center justify-center text-center leading-tight break-words`,style:{hyphens:'auto',wordWrap:'break-word'},disabled:gameOver||foundGroups.some(group=>group.includes(index))},
            e('span',{className:'block w-full'},clue.text)
          )
        )
      ),
      e('div',{className:'flex gap-3 mb-6'},
        e('button',{onClick:()=>setSelected([]),disabled:selected.length===0,className:'flex-1 bg-white hover:bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400 text-slate-700 font-semibold py-3 rounded-lg border border-slate-300 transition-colors'},'Deselect'),
        e('button',{onClick:handleSubmit,disabled:selected.length!==4||gameOver,className:'flex-1 bg-slate-800 hover:bg-slate-900 disabled:bg-slate-300 disabled:text-slate-500 text-white font-semibold py-3 rounded-lg transition-colors'},'Submit')
      ),
      e('div',{className:'grid grid-cols-2 gap-2 bg-white border border-slate-200 rounded-lg p-3'},
        ...Object.entries(CATEGORY_COLORS).map(([category,colors])=>
          e('div',{key:category,className:'flex items-center gap-2'},
            e('div',{className:`w-3 h-3 rounded ${colors.bg}`}),
            e('span',{className:'text-slate-600 text-xs capitalize'},category)
          )
        )
      )
    )
  );
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(e(DiagnoLink));
